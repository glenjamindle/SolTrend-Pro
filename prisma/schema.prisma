// SolTrend Pro - Prisma Schema
// Phase 1: Foundation - Core Entities

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User & Authentication
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String?
  name          String
  role          UserRole  @default(FIELD_SUPERVISOR)
  avatar        String?
  phone         String?
  
  // NextAuth Relations
  accounts      Account[]
  sessions      Session[]
  
  // SolTrend Relations
  companyId     String?
  company       Company?  @relation(fields: [companyId], references: [id])
  inspections   Inspection[]  @relation("UserInspections")
  refusalsReported Refusal[]  @relation("ReportedRefusals")
  refusalsResolved Refusal[]  @relation("ResolvedRefusals")
  productionLogs ProductionLog[]  @relation("RecordedProduction")
  activities    Activity[]  @relation("UserActivities")
  reportsGenerated Report[]  @relation("GeneratedReports")
  projectsManaged Project[]  @relation("ManagedProjects")
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  @@index([companyId])
  @@index([email])
}

enum UserRole {
  ADMIN
  PROJECT_MANAGER
  FIELD_SUPERVISOR
  CREW_LEAD
  INSPECTOR
}

// ============================================
// Company & Multi-tenancy
// ============================================

model Company {
  id            String    @id @default(cuid())
  name          String
  tier          CompanyTier @default(STANDARD)
  logo          String?
  
  // Relations
  users         User[]
  projects      Project[]
  crews         Crew[]
  subcontractors Subcontractor[]
  rackingProfiles RackingProfile[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

enum CompanyTier {
  FREE
  STANDARD
  PROFESSIONAL
  ENTERPRISE
}

// ============================================
// Project Management
// ============================================

model Project {
  id              String    @id @default(cuid())
  name            String
  location        String
  client          String
  status          ProjectStatus @default(ACTIVE)
  health          ProjectHealth @default(GREEN)
  
  // Pile counts
  totalPiles      Int       @default(0)
  installedPiles  Int       @default(0)
  passedInspections Int     @default(0)
  failedInspections Int     @default(0)
  refusalCount    Int       @default(0)
  
  // Dates
  startDate       DateTime
  plannedEndDate  DateTime
  actualEndDate   DateTime?
  
  // Configuration
  dailyTarget     Int       @default(35)
  rackingProfileId String?
  rackingProfile  RackingProfile? @relation(fields: [rackingProfileId], references: [id])
  
  // Weather location
  weatherLat      Float?
  weatherLng      Float?
  
  // Relations
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id])
  projectManagerId String?
  projectManager  User?    @relation("ManagedProjects", fields: [projectManagerId], references: [id])
  piles           Pile[]
  inspections     Inspection[]
  refusals        Refusal[]
  productionLogs  ProductionLog[]
  reports         Report[]
  activities      Activity[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([companyId])
  @@index([status])
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  ON_HOLD
  COMPLETED
  ARCHIVED
}

enum ProjectHealth {
  GREEN
  YELLOW
  RED
}

// ============================================
// Racking Profiles (Tolerance Configurations)
// ============================================

model RackingProfile {
  id            String    @id @default(cuid())
  name          String
  manufacturer  String
  
  // Pile type tolerances stored as JSON
  tolerances    Json
  
  // Relations
  companyId     String?
  company       Company?  @relation(fields: [companyId], references: [id])
  projects      Project[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([manufacturer])
}

// ============================================
// Pile (Individual pile location)
// ============================================

model Pile {
  id            String    @id @default(cuid())
  pileId        String    // Format: "row-pile" e.g., "35-22"
  rowNumber     Int
  pileNumber    Int
  
  // Status
  status        PileStatus @default(NOT_STARTED)
  
  // Location (optional GPS coordinates)
  latitude      Float?
  longitude     Float?
  
  // Relations
  projectId     String
  project       Project   @relation(fields: [projectId], references: [id])
  inspections   Inspection[]
  refusals      Refusal[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([projectId, pileId])
  @@index([projectId])
  @@index([status])
}

enum PileStatus {
  NOT_STARTED
  INSTALLED
  PASSED
  FAILED
  REFUSAL
  REMEDIATED
}

// ============================================
// QC Inspection
// ============================================

model Inspection {
  id            String    @id @default(cuid())
  
  // Pile reference
  pileId        String    // Format: "row-pile"
  rowNumber     Int
  pileNumber    Int
  
  // Inspection results
  status        InspectionStatus
  depth         Int?      // in inches
  plumbNS       Float?    // degrees
  plumbEW       Float?    // degrees
  twist         Float?    // degrees
  embedment     Int?      // in inches
  
  // Failure details
  failReason    String?
  failNotes     String?
  
  // Batch info
  batchId       String?
  
  // Relations
  projectId     String
  project       Project   @relation(fields: [projectId], references: [id])
  pileIdFull    String?
  pile          Pile?     @relation(fields: [pileIdFull], references: [id])
  inspectorId   String
  inspector     User      @relation("UserInspections", fields: [inspectorId], references: [id])
  photos        Photo[]
  
  // Metadata
  deviceInfo    String?
  gpsLat        Float?
  gpsLng        Float?
  
  inspectedAt   DateTime  @default(now())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([projectId])
  @@index([inspectorId])
  @@index([status])
  @@index([inspectedAt])
}

enum InspectionStatus {
  PASS
  FAIL
}

// ============================================
// Refusal Logging
// ============================================

model Refusal {
  id            String    @id @default(cuid())
  
  // Pile reference
  pileId        String    // Format: "row-pile"
  rowNumber     Int
  pileNumber    Int
  
  // Refusal details
  reason        RefusalReason
  targetDepth   Int       // in inches
  achievedDepth Int       // in inches
  
  // Resolution
  status        RefusalStatus @default(OPEN)
  resolution    String?
  resolvedAt    DateTime?
  resolvedById  String?
  resolvedBy    User?     @relation("ResolvedRefusals", fields: [resolvedById], references: [id])
  
  // Relations
  projectId     String
  project       Project   @relation(fields: [projectId], references: [id])
  pileIdFull    String?
  pile          Pile?     @relation(fields: [pileIdFull], references: [id])
  reportedById  String
  reportedBy    User      @relation("ReportedRefusals", fields: [reportedById], references: [id])
  photos        Photo[]
  
  // Metadata
  notes         String?
  deviceInfo    String?
  gpsLat        Float?
  gpsLng        Float?
  
  reportedAt    DateTime  @default(now())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([projectId])
  @@index([status])
  @@index([reportedAt])
}

enum RefusalReason {
  BEDROCK
  COBBLE
  OBSTRUCTION
  GROUNDWATER
  UTILITY_CONFLICT
  OTHER
}

enum RefusalStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

// ============================================
// Production Logging
// ============================================

model ProductionLog {
  id            String    @id @default(cuid())
  date          DateTime  @db.Date
  
  // Production counts
  pilesInstalled Int
  inspectionsPassed Int
  inspectionsFailed Int
  refusalsLogged Int
  
  // Relations
  projectId     String
  project       Project   @relation(fields: [projectId], references: [id])
  crewId        String?
  crew          Crew?     @relation(fields: [crewId], references: [id])
  subcontractorId String?
  subcontractor Subcontractor? @relation(fields: [subcontractorId], references: [id])
  recordedById  String
  recordedBy    User      @relation("RecordedProduction", fields: [recordedById], references: [id])
  
  // Additional info
  notes         String?
  weatherConditions String?
  temperature   Float?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([projectId, date])
  @@index([projectId])
  @@index([date])
}

// ============================================
// Crew Management
// ============================================

model Crew {
  id            String    @id @default(cuid())
  name          String
  lead          String?
  status        CrewStatus @default(ACTIVE)
  
  // Relations
  companyId     String
  company       Company   @relation(fields: [companyId], references: [id])
  productionLogs ProductionLog[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([companyId])
}

enum CrewStatus {
  ACTIVE
  STANDBY
  OFFLINE
}

// ============================================
// Subcontractor
// ============================================

model Subcontractor {
  id            String    @id @default(cuid())
  name          String
  contactPerson String?
  phone         String?
  email         String?
  
  // Relations
  companyId     String
  company       Company   @relation(fields: [companyId], references: [id])
  productionLogs ProductionLog[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([companyId])
}

// ============================================
// Photos
// ============================================

model Photo {
  id            String    @id @default(cuid())
  url           String    // S3 URL or base64 for offline
  thumbnailUrl  String?
  
  // Metadata
  filename      String?
  mimeType      String
  size          Int       // bytes
  width         Int?
  height        Int?
  
  // GPS data
  gpsLat        Float?
  gpsLng        Float?
  gpsAccuracy   Float?
  
  // Captured at
  capturedAt    DateTime
  
  // Relations (polymorphic - one of these will be set)
  inspectionId  String?
  inspection    Inspection? @relation(fields: [inspectionId], references: [id])
  refusalId     String?
  refusal       Refusal?    @relation(fields: [refusalId], references: [id])
  productionLogId String?
  
  uploadedAt    DateTime  @default(now())
  createdAt     DateTime  @default(now())

  @@index([inspectionId])
  @@index([refusalId])
}

// ============================================
// Reports
// ============================================

model Report {
  id            String    @id @default(cuid())
  type          ReportType
  title         String
  
  // Date range
  startDate     DateTime
  endDate       DateTime
  
  // Generated PDF
  pdfUrl        String?
  
  // Distribution
  emailedTo     String[]  // list of email addresses
  emailedAt     DateTime?
  
  // Relations
  projectId     String
  project       Project   @relation(fields: [projectId], references: [id])
  generatedById String?
  generatedBy   User?     @relation("GeneratedReports", fields: [generatedById], references: [id])
  
  generatedAt   DateTime  @default(now())
  createdAt     DateTime  @default(now())

  @@index([projectId])
  @@index([type])
}

enum ReportType {
  DAILY_PRODUCTION
  WEEKLY_PRODUCTION
  MONTHLY_PRODUCTION
  QC_SUMMARY
  PILE_STATUS
  REFUSAL_SUMMARY
  CUSTOM
}

// ============================================
// Activity Log (Audit Trail)
// ============================================

model Activity {
  id            String    @id @default(cuid())
  type          ActivityType
  message       String
  entityType    String    // 'inspection', 'refusal', 'project', etc.
  entityId      String
  
  // Relations
  projectId     String?
  project       Project?  @relation(fields: [projectId], references: [id])
  userId        String
  user          User      @relation("UserActivities", fields: [userId], references: [id])
  
  metadata      Json?
  
  createdAt     DateTime  @default(now())

  @@index([projectId])
  @@index([userId])
  @@index([createdAt])
}

enum ActivityType {
  INSPECTION_PASS
  INSPECTION_FAIL
  REFUSAL_LOGGED
  REFUSAL_RESOLVED
  PRODUCTION_LOGGED
  REPORT_GENERATED
  PROJECT_CREATED
  PROJECT_UPDATED
  USER_LOGIN
  USER_LOGOUT
  SETTINGS_CHANGED
}

// ============================================
// Sessions (for NextAuth)
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?  @db.Text
  access_token      String?  @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?  @db.Text
  session_state     String?
  
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String  @id @default(cuid())
  sessionToken String  @unique
  userId       String
  expires      DateTime
  user         User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
